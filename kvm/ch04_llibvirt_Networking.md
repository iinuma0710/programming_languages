# libvirt の仮想ネットワーク
仮想ネットワークの仕組みを理解することは非常に重要です．
仮想ネットワークの導入によって管理面でもコスト面でも大きなメリットを得られます．
本章では，仮想ネットワークと Linux ベースのネットワークの概念について説明し，物理ネットワークとの比較を行います．
また，per-host や spanned-across-hosts のための仮想スイッチや，シングルルート入出力仮想化の概念についても扱います．
さらに，基本に立ち返って，クラウドのような大規模環境へのスケーラビリティを確保する方法についても見ていきます．

- 物理/仮想ネットワークを理解する
- TAP/TUN を使う
- Linux ブリッジを実装する
- Open vSwitch を設定する
- SR-IOV の理解して設定する
- macvtap を理解する

## 物理/仮想ネットワークを理解する
実際のところ，物理ネットワークだろうと仮想ネットワークだろうと，大きな差はありません．
ただし，トポロジーに関連した違いがいくつかあります．
すなわち，物理的なオブジェクトと同じ働きをするソフトウェアベースのオブジェクトが存在するということです．

それではまず，仮想化されたネットワークの基本的な構成要素である，仮想スイッチについて見てみましょう．
仮想スイッチは，次の2つを実現するソフトウェアベースのレイヤ2スイッチのことです．

- 仮想マシンを接続する
- アップリンクを使って物理サーバのカードに接続し，物理ネットワークのカードを物理スイッチに接続できるようにする

物理ネットワークカードと仮想マシンの間に，ソフトウェアベースの仮想スイッチを挿入しなければ，物理ネットワークのポートを持つ仮想マシンしか，物理ネットワークに接続できなくなってしまいます．
これは，効率性や統一性といった仮想化の基本原則に違反していますし，何よりコストがかかります．
仮想マシンの台数分だけ物理ポートを用意するのは非現実的です．  
そこで，仮想スイッチを導入することで，サーバに必要な物理ネットワークのアダプタを削減し，仮想マシンをネットワークに接続するのに必要なスイッチのポートが少なくて済みます．
また，物理ネットワークカード1枚で複数の仮想マシンへの接続を賄えるため，効率性の問題も解決できます．

## 仮想ネットワーク
仮想スイッチと仮想マシンの接続には，vNIC (virtual Network Interface Card) と呼ばれるオジェクトを用います．
仮想ネットワークカードで仮想マシンを構成するたびに，物理ネットワークカードを物理スイッチへのアップリンクとして使用する仮想スイッチに接続する機能が提供されます．  
もちろん，このアプローチには潜在的な欠点もあります．
大量の仮想マシンを同じ物理ネットワークカードをアップリンクとして利用する単一の仮想スイッチに接続すると，物理ネットワークに接続できなくなります．
これには，仮想スイッチを複数の物理アップリンクを使用することで対処します．

Linux には，以下に挙げるものを代表に，20種類近いネットワークインターフェイスが用意されています．

- ブリッジ (bridge)  
  (仮想マシン) ネットワーク向けのレイヤ2インターフェイス
- ボンド (bond)  
  バランシングとフェイルオーバのため，ネットワークインターフェイスを1つの論理インターフェイスにまとめる
- チーム (team)  
  論理インターフェイスを作成せずにバランシングとフェイルオーバを行う
- MACVLAN  
  レイヤ2上の単一物理インターフェイスに複数の MAC アドレスを割り当てる
- IPVLAN  
  MACVLAN とは異なり，同じ MAC アドレスを使用しレイヤ 3 で多重化される
- MACVTAP/IPVTAP  
  TUN と TAP，ブリッジを組み合わせて仮想ネットワークをシンプルにする新しいドライバ
- VXLAN  
  クラウドオーバレイネットワークで一般的に使われる
- VETH  
  ローカルのトンネリングで使われる仮想イーサネットインタフェース
- IPOIB (IP over Infiniband)  
  HPC や低遅延ネットワークの普及によって Linux カーネルでサポートされるようになった

また，ネットワークインターフェイスの他に，10種類のトンネリングインターフェイスが用意されています．

- GRETAP, GRE: Generic Routing Encapsulation  
  レイヤ2とレイヤ3のプロトコルをカプセル化するプロトコル
- GENEVE  
  VXLAN や GRE などを融合したクラウドオーバレイネットワーク向けのプロトコルで，Open vSwitch や VMware NSX でサポートされる
- IPIP  
  パブリックなネットワーク経由で内部的な IPv4 サブネット接続を IP over IP トンネルで実現する
- SIT: Simple Internet Translation  
  IPv4 経由で独立した IPv6 ネットワークをつなぐ
- ip6tnl  
  IPv6 のトンネルインターフェイスを用いて IPv4/6 のトンネルを実現する
- IR6GRE, IP6GRETAP  

本節では，KVM 仮想化にとって重要な TAP/TUN とブリッジ，Open vSwitch，MACVTAP インターフェイスを扱います．
しかし，これらについて詳しく見ていく前に，NAT や Routed，Isolated といった基本的な仮想ネットワークの概念について説明していきます．

### libvirt の NAT ネットワーク
自宅でインターネットを利用する場合，インターネットに接続するデバイスにはパブリックな IP アドレスが割り当てられ，ローカル側ではそれぞれのデバイスにサブネットが割り当てられています．
同様に，仮想マシンは NAT モードの libvirt スイッチに接続されています．
仮想マシンはホストの IP アドレスを介して物理ネットワークに接続されたものとは通信できますが，その逆はできません．
NAT の向こう側にある仮想マシンと通信するためには，仮想マシンが通信を開始するか，ポートフォワーディングなどの設定をしておく必要があります．

<div align="center"><img src="./images/libvirt_nat.jpeg" width=600></div>

上の図のように仮想マシンの側から見ると，完全に独立したネットワークセグメントに配置され，仮想ネットワークスイッチをゲートウェイとして外部のネットワークへのアクセスに利用しています．

### libvirt の routed ネットワーク
2つ目のタイプはルーティングされたネットワークです．
このネットワークでは，仮想マシンが仮想スイッチを介して物理ネットワークに接続され，仮想マシンは物理ホストと同じレイヤー2や3に位置しています．
自環境において別に NAT ネットワークを用意しなくても仮想マシンに接続できるため，非常によく用いられます．
ただし，仮想マシンに使用するNATネットワークを意識してルーティングを設定する必要があります．

<div align="center"><img src="./images/libvirt_routed.jpeg" width=600></div>

ここまで見てきた2種類のネットワークとは異なり，isolated モードでは仮想スイッチがアップリンクに接続されません．
そのため，スイッチの中だけで通信が行われます．

### libvirt の isolated ネットワーク
先にも述べた通り，isolated モードでは仮想スイッチに接続した仮想マシンの間でのみ通信が可能となります．
この方法は，ある特定のトラフィックを物理ネットワークから切り離すのに非常に便利です．  
例えば，WordPress のような Web サービスを稼働している仮想マシンがあったとき，routed モードのネットワークと isolated モードのネットワークを用意しておき，後者にデータベースなどを稼働している仮想マシンを接続して，それらが外部からアクセスできないようにしてやります．
このように，isolated モードはセキュリティが重要な場面でしばしば利用されます．

<div align="center"><img src="./images/libvirt_isolated.jpeg" width=600></div>

第3章のように必要なパッケージをすべてインストールすると，デフォルトの仮想スイッチがそのまま設定されます．
VMware の vSphere でも同様の設定が行われますし，Hyper-V ではデプロイの過程で仮想スイッチの設定を行うか聞かれます．  
デフォルトの仮想スイッチは，DHCP サーバがアクティブな NAT モードで動作し，作成した仮想マシンい対して IP の設定などがなされた状態となるため，直ぐに使い始めることができます．

<div align="center"><img src="./images/libvirt_default_nat.jpeg" width=600></div>

それでは，仮想ネットワークの設定方法について見ていきましょう．

1. デフォルトネットワークの設定が書かれた XML ファイルをテンプレートとして，新しいネットワークファイルを作ってみましょう．
2. 
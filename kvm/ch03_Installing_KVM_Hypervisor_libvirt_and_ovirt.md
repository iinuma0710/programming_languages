# KVM ハイパーバイザと libvirt・oVirt のインストール
本章では，カーネル仮想マシン (KVM: Kernel Virtual Machine) と，その管理ツールである libvirt と oVirt について扱います．
また，これらツールのインストールについても見ていきます．
特に oVirt は Python ベースのデーモンやサポートするユーティリティ，ライブラリ，GUI フロントエンドなど，オプションが多いため，ステップバイステップでインストールしていきます．  
具体的な内容は次のとおりです．

- QEMU と libvirt に詳しくなる
- oVirt に詳しくなる
- QEMU，libvirt，oVirt をインストールする
- QEMU と libvirt で仮想マシンを始める

## QEMU と libvirt に詳しくなる
QEMU をマシンエミュレータとして利用した場合には，サポートされているあらゆるプラットフォーム上で仮想マシンを作成したり実行したりできます．
ただし，ここでは QEMU をバーチャライザとして使用した場合に焦点を絞ります．
この時，CPU 上で直接仮想マシンのコードを実行できるので，オーバヘッドが小さくネイティブかそれに近い性能を引き出せます．
QEMU はモジュール方式を採用しており，効率的に物理リソースを活用できます．

libvirt を QEMU の管理プラットフォームとして利用する場合，**virsh** コマンドのようなユーティリティが使えるようになります．
これによって，仮想マシンや仮想ネットワークの管理など，さまざまな操作が可能です．
oVirt のようなツールは，libvirt を API として使い，GUI ユーティリティを構築しています．
他にも，サーバが KVM に対応しているかを確認する ```virt-host-validate``` のように，さまざまなコマンドが用意されています．

## oVirt に詳しくなる
システム管理は基本的に全てコマンドラインツールで処理することが可能です．
しかし，仮想マシンマネージャのような GUI ツールも使えると便利です．

現状，大規模な KVM 環境を管理する場面には直面していませんが，いずれ環境のスケールアウトを考える段になると，前述のようなコマンドラインツールだけでは大変不便です．
複数のハイパーバイザに接続し，ネットワークやストレージ，メモリ，CPU など，仮想化の4本柱と呼ばれるすべての機能を管理するようなツールには，GUI を備えていることが望ましいと言えます．
oVirt は，KVM ベースの環境で WEB ベースのコンソールから一元的にシステムの管理を行う，オープンソースの GUI ツールとなっています．

oVirt は，GUI で接続可能なエンジンとホストと通信を行うエージェントというブロックに分けられます．
エンジンブロックでは，仮想マシンの管理や移動，イメージの作成，ストレージや仮想ネットワークの管理などを一元的に行うことが可能です．
エンジンで行った操作をホスト側に反映する役割を担っているのがエージェント (vdsm) です．
oVirt のエンジンでは次のような操作が可能です．

- 仮想マシンのライブマイグレーション
- イメージ管理
- OVF 形式を使った仮想マシンのエクスポートやインポート
- V2V (Virtusl-to-Virtual) 変換
- 可用性の向上
- リソースの監視

oVirt では vdsm と呼ばれるエージェントを介して，oVirt エンジンによる GUI ベースでの管理を実現しています．
vdsm は Python ベースのエージェントで，KVM ホストと直接通信し，ローカルにインストールされた libvirt で必要な操作を行います．
また，仮想ネットワークやストレージの管理，アクセスなどを設定するのにも利用されています．
さらに，vdsmはMOM（Memory Overcommitment Manager）によって，仮想化ホストのメモリを効率的に管理することができます．

oVirt のアーキテクチャをした図に示します．

<div align="center"><img src="./images/ovirt_architecture.jpeg" width=600></div>

## QEMU・libvirt・oVirt のインストール
初めに，基本的な情報から見ていきます．

- OS は Ubuntu (書籍内では CentOS 8 を使用)
- GUI の使えるサーバを想定
- 必要なものは全て手動でインストールする
- サンプルは物理16コアのCPUと64GBのメモリを搭載したマシンで実行している

初めに，必要なパッケージをインストールします．

```bash
$ sudo apt install virt
$ 
```